<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ask Llama 3.2 with Sidebar</title>

    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-track { background-color: #111827; }

        /* Sidebar styles */
        .sidebar { transition: transform 0.1s ease; background-color: #374151; }
        .sidebar-hidden { transform: translateX(-100%); }

        /* Header and Main Container styles */
        .header-color { background-color: #1f2937; height: 52px; }
        .main-container { transition: margin-left 0.1s ease; }
        .sidebar-open { margin-left: 16rem; }
        .header-color-sidebar-header { background-color: #374151; height: 52px; }

        /* Chat Card styles */
        .a4-ratio {
            height: calc(100vh - 52px); /* Available space minus header */
            width: 100%; /* Full width */
            margin: 0; /* Remove any default margin */
            padding: 0 16rem; /* Padding for chat card */
            background-color: #1A1A1A; /* Background for chat card */
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .a4-ratio {
                padding: 0 10rem; /* Padding for medium-sized screens */
            }
        }

        @media (max-width: 1024px) {
            .a4-ratio {
                padding: 0 6rem; /* Further reduced padding for smaller screens */
            }
        }

        @media (max-width: 768px) {
            .a4-ratio {
                padding: 0; /* No padding on mobile */
            }
        }

        /* Chat container styles */
        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #2A2A2A; /* Background color for chat */
        }

        /* Input area styles */
        .input-area {
            margin: 32px 0; /* Margin for input area */
            display: flex; /* Flex layout for the input area */
            align-items: center; /* Center items vertically */
            background-color: #2A2A2A; /* Background color for input area */
            padding: 5px; /* Padding for input area */
            border-radius: 9999px; /* Rounded corners */
        }

        .input-field {
            flex-grow: 1; /* Take up remaining space */
            background-color: transparent; /* Transparent background */
            color: #CCCCCC; /* Text color */
            padding: 0.5rem; /* Padding for the input */
            border: none; /* No border */
            border-radius: 9999px; /* Rounded corners */
        }

        .input-field:focus {
            outline: none; /* Remove outline on focus */
        }

        /* Auto-scroll button */
        #enableScrollButton {
            display: none;
            position: fixed;
            bottom: 70px;
            right: 10px;
            background-color: #333;
            color: white;
            border-radius: 5px;
            padding: 8px;
        }
    </style>
</head>
<body class="font-sans bg-gray-100 flex">

    <!-- Sidebar -->
    <div id="mySidebar" class="sidebar text-white w-64 fixed top-0 left-0 h-full overflow-y-auto">
        <div class="p-4 flex justify-between items-center header-color-sidebar-header">
            <button id="closeBtn" class="transparent-btn text-white text-2xl cursor-pointer">&#9776;</button>
        </div>
        <ul class="space-y-2 p-4">
          
            <hr class="border-gray-700 my-2">

        </ul>
    </div>

    <!-- Main content with header -->
    <div id="mainContainer" class="main-container sidebar-open flex-grow flex flex-col">
        <header class="header-color text-white p-4 flex items-center">
            <button id="toggleBtn" class="transparent-btn text-white text-2xl cursor-pointer">&#9776;</button>
            <div class="flex-1 text-lg font-bold" id="llamaLabel">llama3.2</div>
            <div class="flex-1 flex justify-end">
                <div class="icon-btn">
                    <i class="fas fa-cog text-white"></i>
                </div>
            </div>
        </header>

        <!-- Chat Card -->
        <div class="a4-ratio flex flex-col">
            <div id="chatContainer" class="chat-container">
                <!-- Chat messages will appear here -->
            </div>

            <!-- Input area -->
            <div class="input-area">
                <input id="userInput" type="text" class="input-field" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
                <button class="p-2 ml-1 rounded-full bg-white flex items-center justify-center" onclick="sendPrompt()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="#1A1A1A">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-9.192-4.596a.75.75 0 00-1.084.67v9.516a.75.75 0 001.084.67l9.192-4.596a.75.75 0 000-1.34z" />
                    </svg>
                </button>
            </div>
        </div>
        <!-- Auto-scroll button -->
        <button id="enableScrollButton" onclick="enableAutoScroll()">Enable Auto Scroll</button>
    </div>

    <script>
        const sidebar = document.getElementById('mySidebar');
        const mainContainer = document.getElementById('mainContainer');
        const toggleBtn = document.getElementById('toggleBtn');
        const closeBtn = document.getElementById('closeBtn');
        const llamaLabel = document.getElementById('llamaLabel');
        const enableScrollButton = document.getElementById('enableScrollButton');
        let autoScroll = true;

        const isMobile = () => window.innerWidth <= 768;

        function toggleSidebar() {
            const isHidden = sidebar.classList.toggle('sidebar-hidden');
            mainContainer.classList.toggle('sidebar-open', !isHidden);
            llamaLabel.style.marginLeft = isHidden ? '20px' : '0';
            toggleBtn.style.display = isHidden ? 'block' : 'none'; // Toggle visibility of the button
        }

        function checkMobile() {
            const hidden = isMobile();
            sidebar.classList.toggle('sidebar-hidden', hidden);
            mainContainer.classList.toggle('sidebar-open', !hidden);
            toggleBtn.style.display = hidden ? 'block' : 'none'; // Show/hide toggle button based on mobile view
            llamaLabel.style.marginLeft = hidden ? '20px' : '0';
        }

        document.addEventListener('DOMContentLoaded', () => {
            closeBtn.addEventListener('click', toggleSidebar);
            toggleBtn.addEventListener('click', toggleSidebar);

            // Check mobile on page load
            checkMobile();
window.addEventListener('resize', () => {
    checkMobile(); // Check on resize
});

// Set initial visibility based on sidebar state
toggleBtn.style.display = sidebar.classList.contains('sidebar-hidden') ? 'block' : 'none';
llamaLabel.style.marginLeft = sidebar.classList.contains('sidebar-hidden') ? '20px' : '0';
});

// Chat Functionality
let conversationContext = [];
let currentAIResponse = "";  // Holds the current AI response for a single bubble
autoScroll = true;       // Control auto-scroll behavior

window.onload = () => {
    const inputField = document.getElementById("userInput");
    inputField.focus();
};

window.onkeydown = () => {
    document.getElementById("userInput").focus();  // Always focus input
};

function handleKeyPress(event) {
    if (event.key === "Enter") {
        sendPrompt();
        autoScroll = true;  // Enable auto-scroll on new user input
        enableScrollButton.style.display = 'none'; // Hide auto-scroll button
    }
}

document.getElementById("chatContainer").addEventListener('scroll', () => {
    const chatContainer = document.getElementById("chatContainer");

    // Check if the user has scrolled up manually
    if (chatContainer.scrollTop + chatContainer.clientHeight < chatContainer.scrollHeight) {
        autoScroll = false;
        enableScrollButton.style.display = 'block'; // Show the auto-scroll button when scrolling is disabled
    }
});

function enableAutoScroll() {
    autoScroll = true;
    enableScrollButton.style.display = 'none';  // Hide the button after enabling auto-scroll
    scrollToBottom();  // Scroll to the bottom when auto-scroll is enabled
}

async function sendPrompt() {
    const inputField = document.getElementById("userInput");
    const userMessage = inputField.value.trim();
    inputField.value = "";  // Clear input field

    if (!userMessage) return;

    // Display the user's message
    appendMessage(userMessage, 'user');

    // Prepare the request body
    const requestBody = {
        model: 'llama3.2:1b',
        prompt: userMessage,
        context: conversationContext.length > 0 ? conversationContext : []
    };

    try {
    const response = await fetch('http://localhost:11434/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody)
    });

    if (!response.ok) {
        throw new Error("Bad Request");
    }

    // Process the streamed response
    const reader = response.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let done = false;
    let tokenBuffer = '';
    currentAIResponse = "";  // Reset the current AI response

    let aiMessageElement = appendMessage('', 'agent', true);  // Start a new AI message bubble

    while (!done) {
        const { value, done: readerDone } = await reader.read();
        done = readerDone;

        if (value) {
            tokenBuffer += decoder.decode(value, { stream: true });

            // Split on newline to process each token individually
            const tokens = tokenBuffer.split('\n');
            tokenBuffer = tokens.pop();  // Keep the last incomplete token in buffer

            tokens.forEach(token => {
                if (token.trim()) {
                    try {
                        const parsed = JSON.parse(token);
                        currentAIResponse += parsed.response;  // Append token to the current AI response
                        aiMessageElement.textContent = currentAIResponse;  // Update the AI bubble in real-time

                        if (parsed.context) {
                            conversationContext.push(...parsed.context);  // Update context safely
                        }

                        if (autoScroll) {
                            scrollToBottom();  // Auto-scroll if enabled
                        }

                    } catch (error) {
                        console.error("Error parsing token:", error);
                    }
                }
            });
        }
    }
} catch (error) {
    appendMessage(`Error: ${error.message}`, 'agent');
}

}

// Function to append a message to the chat
function appendMessage(message, sender, isTemporary = false) {
    const chatContainer = document.getElementById("chatContainer");
    const messageElement = document.createElement("div");
    messageElement.classList.add('p-2', 'rounded-md', 'mb-2', 'w-fit', 'max-w-full');

    if (sender === 'user') {
        messageElement.classList.add('bg-blue-500', 'self-end');
        messageElement.textContent = message;
    } else if (sender === 'agent') {
        messageElement.classList.add('text-white', 'self-start');
        if (isTemporary) {
            chatContainer.appendChild(messageElement);  // Add an empty bubble first
            return messageElement;  // Return the element so we can update it in real-time
        } else {
            messageElement.textContent = message;  // Only add message if it’s a finalized one
        }
    }

    chatContainer.appendChild(messageElement);
    if (autoScroll) {
        scrollToBottom();  // Auto-scroll to bottom when a new message is appended
    }
    return messageElement;
}

// Function to scroll to the bottom of the chat
function scrollToBottom() {
    const chatContainer = document.getElementById("chatContainer");
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

    </script>

</body>
</html>
