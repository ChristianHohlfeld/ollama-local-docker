<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta tags and title -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ask Llama</title>

    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background-color: #555; border-radius: 10px; }
        ::-webkit-scrollbar-track { background-color: #1a1a1a; }

        /* Dark mode colors */
        body { background-color: #121212; color: #e0e0e0; }

        /* Sidebar styles */
        .sidebar { background-color: #1e1e1e; transition: transform 0.2s ease; }
        .sidebar-hidden { transform: translateX(-100%); }

        /* Header styles */
        .header {
            background-color: #1a1a1a;
            height: 52px;
            display: flex;
            align-items: center;
            padding: 0 1rem;
        }

        /* Main container */
        .main-container { transition: margin-left 0.2s ease; }
        .sidebar-open { margin-left: 16rem; }

        /* Chat Card styles */
        .a4-ratio {
            height: calc(100vh - 52px); /* Available space minus header */
            width: 100%; /* Full width */
            max-width: 768px; /* Set maximum width */
            margin: 0 auto; /* Center the container */
            padding: 0 1rem; /* Horizontal padding */
            background-color: #1A1A1A; /* Background for chat card */
            position: relative; /* For positioning the autoscroll button */
            display: flex;
            flex-direction: column;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .a4-ratio {
                padding: 0 0.5rem; /* Slight padding on mobile */
            }
        }

        /* Chat container styles */
        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #1a1a1a;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }

        /* Input area */
        .input-area {
            margin-top: 1rem;
            margin-bottom: 15px; /* Added 15px space below input area */
            display: flex;
            align-items: center;
            background-color: #1e1e1e;
            padding: 0.5rem;
            border-radius: 9999px;
        }

        .input-field {
            flex-grow: 1;
            background-color: transparent;
            color: #e0e0e0;
            padding: 0.5rem;
            border: none;
            border-radius: 9999px;
        }

        .input-field:focus {
            outline: none;
        }

        /* Message bubbles */
        .message {
            margin-bottom: 1rem;
            padding: 0.5rem 1rem; /* Adjusted padding to reduce height */
            border-radius: 9999px; /* Fully rounded */
            word-wrap: break-word;
            display: inline-block; /* Shrink bubble to fit content */
            max-width: 80%; /* Limit width to prevent stretching */
        }

        .message.user {
            background-color: #4b5563; /* Gray background for user messages */
            align-self: flex-end;
            text-align: right;
            color: #ffffff;
        }

        .message.agent {
            /* Removed background color to blend with chat background */
            align-self: flex-start;
            color: #e0e0e0;
        }

        /* Autoscroll Button styles */
        .autoscroll-btn {
            position: absolute;
            /* Positioning the button centered above the input area with a 15px gap */
            bottom: calc(64px + 15px); /* 64px is the approximate height of the input area */
            left: 50%;
            transform: translateX(-50%);
            background-color: #1A1A1A;
            color: #FFFFFF;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
        }

        .autoscroll-btn:hover {
            background-color: #333333;
        }

        .autoscroll-btn.hidden {
            display: none;
        }

        /* Send button styles */
        .send-button {
            background-color: #ffffff; /* White background */
            border-radius: 9999px;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button:hover {
            background-color: #e5e5e5;
        }

        .send-button svg {
            color: #1A1A1A; /* Dark icon color */
        }

        /* Model selector styles */
        .model-dropdown {
            background-color: #1e1e1e;
            color: #e0e0e0;
            padding: 0.5rem;
            border: none;
            border-radius: 0.375rem;
            margin-left: 1rem;
            font-size: 0.875rem;
        }

        .model-dropdown option.unavailable {
            color: gray;
        }

        #pullButton {
            background-color: #ffffff;
            color: #1A1A1A;
            border: none;
            padding: 0.5rem 1rem;
            margin-left: 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            display: none;
        }

        #pullButton:hover {
            background-color: #e5e5e5;
        }

        /* Adjustments for mobile view */
        @media (max-width: 768px) {
            .model-dropdown, #pullButton {
                margin-left: 0.5rem;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body class="font-sans flex">

    <!-- Sidebar -->
    <div id="mySidebar" class="sidebar fixed top-0 left-0 h-full w-64 overflow-y-auto sidebar-hidden">
        <div class="p-4 flex justify-between items-center header">
            <!-- Hamburger icon in the sidebar header -->
            <button id="sidebarHamburger" class="text-white text-2xl cursor-pointer">&#9776;</button>
        </div>
        <ul class="space-y-2 p-4 text-white">
            <li class="hover:bg-gray-700 p-2 rounded cursor-pointer">Menu Item 1</li>
            <li class="hover:bg-gray-700 p-2 rounded cursor-pointer">Menu Item 2</li>
            <hr class="border-gray-600 my-2">
        </ul>
    </div>

    <!-- Main content with header -->
    <div id="mainContainer" class="main-container flex-grow flex flex-col">
        <!-- Header -->
        <header class="header">
            <!-- Hamburger icon in the main header bar -->
            <button id="toggleBtn" class="text-white text-2xl cursor-pointer">&#9776;</button>
            <h1 class="text-lg font-bold ml-4 text-white">Ask Llama</h1>

            <!-- Model Selector -->
            <select id="modelDropdown" class="model-dropdown">
                <option value="" disabled selected>Loading models...</option>
            </select>

            <!-- Pull Button -->
            <button id="pullButton">Pull Selected Model</button>
        </header>

        <!-- Chat area -->
        <div class="a4-ratio">
            <!-- Chat container -->
            <div id="chatContainer" class="chat-container">
                <!-- Chat messages will appear here -->
            </div>

            <!-- Autoscroll Button -->
            <button id="autoscrollButton" class="autoscroll-btn hidden" onclick="enableAutoscroll()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>

            <!-- Input area -->
            <div class="input-area">
                <input id="userInput" type="text" class="input-field" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
                <button class="send-button ml-2" onclick="sendPrompt()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M2.003 21l20.993-9L2.003 3v7l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript Code -->
    <script>
        // Sidebar functionality
        const sidebar = document.getElementById('mySidebar');
        const mainContainer = document.getElementById('mainContainer');
        const toggleBtn = document.getElementById('toggleBtn');
        const sidebarHamburger = document.getElementById('sidebarHamburger');
        const chatContainer = document.getElementById('chatContainer');
        const autoscrollButton = document.getElementById('autoscrollButton');
        let autoScroll = true;

        function toggleSidebar() {
            sidebar.classList.toggle('sidebar-hidden');
            mainContainer.classList.toggle('sidebar-open');

            // Toggle the visibility of the hamburger icon in the main header
            toggleBtn.style.display = sidebar.classList.contains('sidebar-hidden') ? 'block' : 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            sidebarHamburger.addEventListener('click', toggleSidebar);
            toggleBtn.addEventListener('click', toggleSidebar);

            // Adjust sidebar visibility based on screen size
            if (window.innerWidth <= 768) {
                sidebar.classList.add('sidebar-hidden');
                mainContainer.classList.remove('sidebar-open');
                toggleBtn.style.display = 'block';
            } else {
                sidebar.classList.remove('sidebar-hidden');
                mainContainer.classList.add('sidebar-open');
                toggleBtn.style.display = 'none';
            }

            // Initialize the model dropdown
            initializeModelDropdown();
        });

        window.addEventListener('resize', () => {
            if (window.innerWidth <= 768) {
                sidebar.classList.add('sidebar-hidden');
                mainContainer.classList.remove('sidebar-open');
                toggleBtn.style.display = 'block';
            } else {
                sidebar.classList.remove('sidebar-hidden');
                mainContainer.classList.add('sidebar-open');
                toggleBtn.style.display = 'none';
            }
        });

        function handleKeyPress(event) {
            if (event.key === "Enter") {
                sendPrompt();
            }
        }

        async function sendPrompt() {
            const inputField = document.getElementById("userInput");
            const userMessage = inputField.value.trim();
            inputField.value = "";

            if (!userMessage) return;

            appendMessage(userMessage, 'user');

            // Prepare the AI's message bubble
            const aiMessageElement = createMessageElement('', 'agent');
            chatContainer.appendChild(aiMessageElement);
            scrollToBottom();

            const requestBody = {
                model: selectedModel || 'llama3.2:1b', // Use selected model or default
                prompt: userMessage,
                context: []
            };

            try {
                const response = await fetch('api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let done = false;
                let tokenBuffer = '';

                while (!done) {
                    const { value, done: readerDone } = await reader.read();
                    done = readerDone;

                    if (value) {
                        tokenBuffer += decoder.decode(value, { stream: true });
                        const tokens = tokenBuffer.split('\n');
                        tokenBuffer = tokens.pop();

                        tokens.forEach(token => {
                            if (token.trim()) {
                                try {
                                    const parsed = JSON.parse(token);
                                    aiMessageElement.textContent += parsed.response;
                                    scrollToBottom(); // Ensure autoscroll during streaming
                                } catch (error) {
                                    console.error("Error parsing token:", error);
                                }
                            }
                        });
                    }
                }

            } catch (error) {
                aiMessageElement.textContent = `Error: ${error.message}`;
            }
        }

        function createMessageElement(message, sender) {
            const messageElement = document.createElement("div");
            messageElement.classList.add('message');

            if (sender === 'user') {
                messageElement.classList.add('user');
            } else {
                messageElement.classList.add('agent');
            }

            messageElement.textContent = message;
            return messageElement;
        }

        function appendMessage(message, sender) {
            const messageElement = createMessageElement(message, sender);
            chatContainer.appendChild(messageElement);
            scrollToBottom();
        }

        function scrollToBottom() {
            if (autoScroll) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        function disableAutoscroll() {
            autoScroll = false;
            showAutoscrollButton();
        }

        function enableAutoscroll() {
            autoScroll = true;
            scrollToBottom();
            hideAutoscrollButton();
        }

        function showAutoscrollButton() {
            autoscrollButton.classList.remove('hidden');
        }

        function hideAutoscrollButton() {
            autoscrollButton.classList.add('hidden');
        }

        // Check if the user has scrolled away from the bottom
        chatContainer.addEventListener('scroll', () => {
            const isAtBottom = chatContainer.scrollHeight - chatContainer.scrollTop <= chatContainer.clientHeight + 1; // Tolerance

            if (!isAtBottom && autoScroll) {
                disableAutoscroll();
            } else if (isAtBottom && !autoScroll) {
                enableAutoscroll();
            }
        });

        // Model Selector Code
        let selectedModel = ''; // Variable to store the selected model
        let isModelAvailableLocally = false; // Flag to track if the model is local

        // Get references to dropdown and pull button
        const modelDropdown = document.getElementById('modelDropdown');
        const pullButton = document.getElementById('pullButton');

        // List of all available models (local and remote)
        const allModels = [
            { name: 'llama3.1:1b', displayName: 'Llama 3.1 - 1B' },
            { name: 'llama3.1:7b', displayName: 'Llama 3.1 - 7B' },
            { name: 'llama3.2:1b', displayName: 'Llama 3.2 - 1B' },
            { name: 'llama3.2:7b', displayName: 'Llama 3.2 - 7B' },
            { name: 'llama3.2:70b', displayName: 'Llama 3.2 - 70B' },
            { name: 'llama3-gradient', displayName: 'Llama 3 Gradient' },
            { name: 'dolphin-llama3:8b', displayName: 'Dolphin Llama 3 - 8B' },
            { name: 'dolphin-llama3:70b', displayName: 'Dolphin Llama 3 - 70B' },
            { name: 'dolphin-llama3:8b-256k', displayName: 'Dolphin Llama 3 - 8B (256K Context)' },
            { name: 'nous-hermes2', displayName: 'Nous Hermes 2' },
            { name: 'wizard-coder', displayName: 'Wizard Coder' },
            { name: 'all-minilm', displayName: 'All MiniLM' },
            { name: 'aya-23', displayName: 'Aya 23' },
            { name: 'codeqwen-1.5', displayName: 'CodeQwen 1.5' },
            { name: 'wizardlm2', displayName: 'Wizard LM 2' },
            { name: 'command-r-plus', displayName: 'Command R+' },
            { name: 'tinydolphin', displayName: 'TinyDolphin' },
            { name: 'wizardcoder', displayName: 'WizardCoder' },
            { name: 'stable-code', displayName: 'Stable Code' },
            { name: 'openhermes', displayName: 'OpenHermes 2.5' },
            { name: 'qwen2-math', displayName: 'Qwen 2 Math' },
            { name: 'bakllava', displayName: 'BakLLaVA' },
            { name: 'stablelm2', displayName: 'Stable LM 2' },
            { name: 'deepseek-llm', displayName: 'DeepSeek LLM' },
            { name: 'wizard-math', displayName: 'Wizard Math' },
            { name: 'glm4', displayName: 'GLM 4' },
            { name: 'neural-chat', displayName: 'Neural Chat' },
            { name: 'phi3.5', displayName: 'Phi 3.5' }
        ];

        // Fetch the list of locally available models
        async function fetchLocalModels() {
            try {
                const response = await fetch('api/tags');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data.models.map(model => model.name);
            } catch (error) {
                console.error('Error fetching local models:', error);
                return [];
            }
        }

        // Pull the model if it is not available locally
        async function pullModel(modelName) {
            try {
                const response = await fetch('api/pull', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: modelName }),
                });

                if (response.ok) {
                    console.log(`Model ${modelName} is being pulled.`);
                } else {
                    console.error('Error pulling the model:', await response.text());
                }
            } catch (error) {
                console.error('Error pulling the model:', error);
            }
        }

        // Initialize the dropdown with models
        async function initializeModelDropdown() {
            // Clear the current dropdown options
            modelDropdown.innerHTML = '<option value="" disabled selected>Select a model...</option>';

            // Fetch local models
            const localModels = await fetchLocalModels();

            // Populate the dropdown with models
            allModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                option.textContent = model.displayName;

                if (localModels.includes(model.name)) {
                    // Local model (available)
                    option.classList.remove('unavailable');
                } else {
                    // Unavailable model (gray)
                    option.classList.add('unavailable');
                }

                modelDropdown.appendChild(option);
            });

            // Set default selected model if available
            if (localModels.includes('llama3.2:1b')) {
                selectedModel = 'llama3.2:1b';
                modelDropdown.value = 'llama3.2:1b';
            }
        }

        // Event listener for when a model is selected
        modelDropdown.addEventListener('change', async function() {
            selectedModel = this.value;

            // Check if the model is available locally
            const localModels = await fetchLocalModels();
            isModelAvailableLocally = localModels.includes(selectedModel);

            if (isModelAvailableLocally) {
                console.log(`Model ${selectedModel} is already available locally.`);
                pullButton.style.display = 'none'; // Hide the pull button if model is local
            } else {
                console.log(`Model ${selectedModel} is not available locally.`);
                pullButton.style.display = 'inline-block'; // Show the pull button if model is not local
            }
        });

        // Event listener for pulling the model manually
        pullButton.addEventListener('click', async function() {
            if (!isModelAvailableLocally && selectedModel) {
                console.log(`Pulling model: ${selectedModel}`);
                await pullModel(selectedModel);
            }
        });
    </script>

</body>
</html>
