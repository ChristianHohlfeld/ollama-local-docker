<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta tags and title -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ask Llama 3.2</title>

    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background-color: #555; border-radius: 10px; }
        ::-webkit-scrollbar-track { background-color: #1a1a1a; }

        /* Dark mode colors */
        body { background-color: #121212; color: #e0e0e0; }

        /* Sidebar styles */
        .sidebar { background-color: #1e1e1e; transition: transform 0.2s ease; }
        .sidebar-hidden { transform: translateX(-100%); }

        /* Header styles */
        .header { background-color: #1a1a1a; height: 52px; }

        /* Main container */
        .main-container { transition: margin-left 0.2s ease; }
        .sidebar-open { margin-left: 16rem; }

        /* Chat Card styles */
        .a4-ratio {
            height: calc(100vh - 52px); /* Available space minus header */
            width: 100%; /* Full width */
            max-width: 768px; /* Set maximum width */
            margin: 0 auto; /* Center the container */
            padding: 0 1rem; /* Horizontal padding */
            background-color: #1A1A1A; /* Background for chat card */
            position: relative; /* For positioning the autoscroll button */
            display: flex;
            flex-direction: column;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .a4-ratio {
                padding: 0 0.5rem; /* Slight padding on mobile */
            }
        }

        /* Chat container styles */
        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #1a1a1a;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }

        /* Input area */
        .input-area {
            margin-top: 1rem;
            margin-bottom: 15px; /* Added 15px space below input area */
            display: flex;
            align-items: center;
            background-color: #1e1e1e;
            padding: 0.5rem;
            border-radius: 9999px;
        }

        .input-field {
            flex-grow: 1;
            background-color: transparent;
            color: #e0e0e0;
            padding: 0.5rem;
            border: none;
            border-radius: 9999px;
        }

        .input-field:focus {
            outline: none;
        }

        /* Message bubbles */
        .message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 8px;
            word-wrap: break-word;
        }

        .message.user {
            background-color: #3b82f6; /* Blue background for user messages */
            align-self: flex-end;
            max-width: 60%;
            text-align: right;
            color: #ffffff;
        }

        .message.agent {
            /* Removed background color to blend with chat background */
            align-self: flex-start;
            width: 100%;
            color: #e0e0e0;
        }

        /* Autoscroll Button styles */
        .autoscroll-btn {
            position: absolute;
            /* Positioning the button centered above the input area with a 15px gap */
            bottom: calc(64px + 15px); /* 64px is the approximate height of the input area */
            left: 50%;
            transform: translateX(-50%);
            background-color: #1A1A1A;
            color: #FFFFFF;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
        }

        .autoscroll-btn:hover {
            background-color: #333333;
        }

        .autoscroll-btn.hidden {
            display: none;
        }
    </style>
</head>
<body class="font-sans flex">

    <!-- Sidebar -->
    <div id="mySidebar" class="sidebar fixed top-0 left-0 h-full w-64 overflow-y-auto sidebar-hidden">
        <div class="p-4 flex justify-between items-center header">
            <!-- Hamburger icon in the sidebar header -->
            <button id="sidebarHamburger" class="text-white text-2xl cursor-pointer">&#9776;</button>
        </div>
        <ul class="space-y-2 p-4 text-white">
            <li class="hover:bg-gray-700 p-2 rounded cursor-pointer">Menu Item 1</li>
            <li class="hover:bg-gray-700 p-2 rounded cursor-pointer">Menu Item 2</li>
            <hr class="border-gray-600 my-2">
        </ul>
    </div>

    <!-- Main content with header -->
    <div id="mainContainer" class="main-container flex-grow flex flex-col">
        <!-- Header -->
        <header class="header text-white p-4 flex items-center">
            <!-- Hamburger icon in the main header bar -->
            <button id="toggleBtn" class="text-white text-2xl cursor-pointer">&#9776;</button>
            <h1 class="text-lg font-bold ml-4">Ask Llama 3.2</h1>
        </header>

        <!-- Chat area -->
        <div class="a4-ratio">
            <!-- Chat container -->
            <div id="chatContainer" class="chat-container">
                <!-- Chat messages will appear here -->
            </div>

            <!-- Autoscroll Button -->
            <button id="autoscrollButton" class="autoscroll-btn hidden" onclick="enableAutoscroll()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>

            <!-- Input area -->
            <div class="input-area">
                <input id="userInput" type="text" class="input-field" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
                <button class="p-2 ml-2" onclick="sendPrompt()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-9.192-4.596a.75.75 0 00-1.084.67v9.516a.75.75 0 001.084.67l9.192-4.596a.75.75 0 000-1.34z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript Code -->
    <script>
        const sidebar = document.getElementById('mySidebar');
        const mainContainer = document.getElementById('mainContainer');
        const toggleBtn = document.getElementById('toggleBtn');
        const sidebarHamburger = document.getElementById('sidebarHamburger');
        const chatContainer = document.getElementById('chatContainer');
        const autoscrollButton = document.getElementById('autoscrollButton');
        let autoScroll = true;

        function toggleSidebar() {
            sidebar.classList.toggle('sidebar-hidden');
            mainContainer.classList.toggle('sidebar-open');

            // Toggle the visibility of the hamburger icon in the main header
            toggleBtn.style.display = sidebar.classList.contains('sidebar-hidden') ? 'block' : 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            sidebarHamburger.addEventListener('click', toggleSidebar);
            toggleBtn.addEventListener('click', toggleSidebar);

            // Adjust sidebar visibility based on screen size
            if (window.innerWidth <= 768) {
                sidebar.classList.add('sidebar-hidden');
                mainContainer.classList.remove('sidebar-open');
                toggleBtn.style.display = 'block';
            } else {
                sidebar.classList.remove('sidebar-hidden');
                mainContainer.classList.add('sidebar-open');
                toggleBtn.style.display = 'none';
            }
        });

        window.addEventListener('resize', () => {
            if (window.innerWidth <= 768) {
                sidebar.classList.add('sidebar-hidden');
                mainContainer.classList.remove('sidebar-open');
                toggleBtn.style.display = 'block';
            } else {
                sidebar.classList.remove('sidebar-hidden');
                mainContainer.classList.add('sidebar-open');
                toggleBtn.style.display = 'none';
            }
        });

        function handleKeyPress(event) {
            if (event.key === "Enter") {
                sendPrompt();
            }
        }

        async function sendPrompt() {
            const inputField = document.getElementById("userInput");
            const userMessage = inputField.value.trim();
            inputField.value = "";

            if (!userMessage) return;

            appendMessage(userMessage, 'user');

            // Prepare the AI's message bubble
            const aiMessageElement = createMessageElement('', 'agent');
            chatContainer.appendChild(aiMessageElement);
            scrollToBottom();

            const requestBody = {
                model: 'llama3.2:1b',
                prompt: userMessage,
                context: []
            };

            try {
                const response = await fetch('http://127.0.0.1:11434/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error("Bad Request");
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let done = false;
                let tokenBuffer = '';

                while (!done) {
                    const { value, done: readerDone } = await reader.read();
                    done = readerDone;

                    if (value) {
                        tokenBuffer += decoder.decode(value, { stream: true });
                        const tokens = tokenBuffer.split('\n');
                        tokenBuffer = tokens.pop();

                        tokens.forEach(token => {
                            if (token.trim()) {
                                try {
                                    const parsed = JSON.parse(token);
                                    aiMessageElement.textContent += parsed.response;
                                    scrollToBottom(); // Ensure autoscroll during streaming
                                } catch (error) {
                                    console.error("Error parsing token:", error);
                                }
                            }
                        });
                    }
                }

            } catch (error) {
                aiMessageElement.textContent = `Error: ${error.message}`;
            }
        }

        function createMessageElement(message, sender) {
            const messageElement = document.createElement("div");
            messageElement.classList.add('message');

            if (sender === 'user') {
                messageElement.classList.add('user');
            } else {
                messageElement.classList.add('agent');
            }

            messageElement.textContent = message;
            return messageElement;
        }

        function appendMessage(message, sender) {
            const messageElement = createMessageElement(message, sender);
            chatContainer.appendChild(messageElement);
            scrollToBottom();
        }

        function scrollToBottom() {
            if (autoScroll) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        function disableAutoscroll() {
            autoScroll = false;
            showAutoscrollButton();
        }

        function enableAutoscroll() {
            autoScroll = true;
            scrollToBottom();
            hideAutoscrollButton();
        }

        function showAutoscrollButton() {
            autoscrollButton.classList.remove('hidden');
        }

        function hideAutoscrollButton() {
            autoscrollButton.classList.add('hidden');
        }

        // Check if the user has scrolled away from the bottom
        chatContainer.addEventListener('scroll', () => {
            const isAtBottom = chatContainer.scrollHeight - chatContainer.scrollTop <= chatContainer.clientHeight + 1; // Tolerance

            if (!isAtBottom && autoScroll) {
                disableAutoscroll();
            } else if (isAtBottom && !autoScroll) {
                enableAutoscroll();
            }
        });
    </script>

</body>
</html>
