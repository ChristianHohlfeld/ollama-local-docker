<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta tags and title -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ask Llama 3.2 with Sidebar</title>

    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-track { background-color: #111827; }

        /* Sidebar styles */
        .sidebar { transition: transform 0.1s ease; background-color: #374151; }
        .sidebar-hidden { transform: translateX(-100%); }

        /* Header and Main Container styles */
        .header-color { background-color: #1f2937; height: 52px; }
        .main-container { transition: margin-left 0.1s ease; }
        .sidebar-open { margin-left: 16rem; }
        .header-color-sidebar-header { background-color: #374151; height: 52px; }

        /* Chat Card styles */
        .a4-ratio {
            height: calc(100vh - 52px); /* Available space minus header */
            width: 100%; /* Full width */
            max-width: 768px; /* Set maximum width */
            margin: 0 auto; /* Center the container */
            padding: 0 1rem; /* Optional: Add some horizontal padding */
            background-color: #1A1A1A; /* Background for chat card */
            position: relative; /* For positioning the autoscroll button */
            display: flex;
            flex-direction: column;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .a4-ratio {
                padding: 0 0.5rem; /* Optional: Slight padding on mobile */
            }
        }

        /* Chat container styles */
        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #2A2A2A; /* Background color for chat */
        }

        /* Input area styles */
        .input-area {
            margin: 32px 0; /* Margin for input area */
            display: flex; /* Flex layout for the input area */
            align-items: center; /* Center items vertically */
            background-color: #2A2A2A; /* Background color for input area */
            padding: 5px; /* Padding for input area */
            border-radius: 9999px; /* Rounded corners */
        }

        .input-field {
            flex-grow: 1; /* Take up remaining space */
            background-color: transparent; /* Transparent background */
            color: #CCCCCC; /* Text color */
            padding: 0.5rem; /* Padding for the input */
            border: none; /* No border */
            border-radius: 9999px; /* Rounded corners */
        }

        .input-field:focus {
            outline: none; /* Remove outline on focus */
        }

        /* Autoscroll Button styles */
        .autoscroll-btn {
            position: absolute;
            bottom: calc(32px + 64px); /* Adjust based on input-area's margin and height */
            left: 50%;
            transform: translateX(-50%);
            background-color: #1A1A1A;
            color: #FFFFFF;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
        }

        .autoscroll-btn:hover {
            background-color: #333333;
        }

        .autoscroll-btn.hidden {
            display: none;
        }
    </style>
</head>
<body class="font-sans bg-gray-100 flex">

    <!-- Sidebar -->
    <div id="mySidebar" class="sidebar text-white w-64 fixed top-0 left-0 h-full overflow-y-auto sidebar-hidden">
        <div class="p-4 flex justify-between items-center header-color-sidebar-header">
            <!-- Hamburger icon in the sidebar header -->
            <button id="sidebarHamburger" class="transparent-btn text-white text-2xl cursor-pointer">&#9776;</button>
        </div>
        <ul class="space-y-2 p-4">
            <li class="hover:bg-gray-600 p-2 rounded cursor-pointer">Menu Item 1</li>
            <li class="hover:bg-gray-600 p-2 rounded cursor-pointer">Menu Item 2</li>
            <hr class="border-gray-700 my-2">
        </ul>
    </div>

    <!-- Main content with header -->
    <div id="mainContainer" class="main-container flex-grow flex flex-col h-full">
        <header class="header-color text-white p-4 flex items-center">
            <!-- Hamburger icon in the main header bar -->
            <button id="toggleBtn" class="transparent-btn text-white text-2xl cursor-pointer">&#9776;</button>
            <div class="flex-1 text-lg font-bold ml-4" id="llamaLabel">llama3.2</div>
            <div class="flex-1 flex justify-end">
                <div class="icon-btn">
                    <i class="fas fa-cog text-white"></i>
                </div>
            </div>
        </header>

        <!-- Chat Card -->
        <div class="a4-ratio">
            <!-- Chat container -->
            <div id="chatContainer" class="chat-container">
                <!-- Chat messages will appear here -->
            </div>

            <!-- Autoscroll Button -->
            <button id="autoscrollButton" class="autoscroll-btn hidden" onclick="enableAutoscroll()">
                <i class="fas fa-arrow-down"></i>
            </button>

            <!-- Input area -->
            <div class="input-area">
                <input id="userInput" type="text" class="input-field" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
                <button class="p-2 ml-1 rounded-full bg-white flex items-center justify-center" onclick="sendPrompt()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="#1A1A1A">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-9.192-4.596a.75.75 0 00-1.084.67v9.516a.75.75 0 001.084.67l9.192-4.596a.75.75 0 000-1.34z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript Code -->
    <script>
        const sidebar = document.getElementById('mySidebar');
        const mainContainer = document.getElementById('mainContainer');
        const toggleBtn = document.getElementById('toggleBtn');
        const sidebarHamburger = document.getElementById('sidebarHamburger');
        const chatContainer = document.getElementById('chatContainer');
        const autoscrollButton = document.getElementById('autoscrollButton');
        let aiMessageElement = null;
        let autoScroll = true;

        const isMobile = () => window.innerWidth <= 768;

        function toggleSidebar() {
            const isHidden = sidebar.classList.toggle('sidebar-hidden');
            mainContainer.classList.toggle('sidebar-open', !isHidden);

            // Toggle the visibility of the hamburger icon in the main header bar
            if (!isHidden) {
                // Sidebar is now open, hide the hamburger icon in the main header bar
                toggleBtn.style.display = 'none';
            } else {
                // Sidebar is now closed, show the hamburger icon in the main header bar
                toggleBtn.style.display = 'block';
            }
        }

        function checkMobile() {
            const hidden = isMobile();
            sidebar.classList.toggle('sidebar-hidden', hidden);
            mainContainer.classList.toggle('sidebar-open', !hidden);

            // Set the visibility of the toggleBtn based on the sidebar state
            toggleBtn.style.display = hidden ? 'block' : 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            sidebarHamburger.addEventListener('click', toggleSidebar);
            toggleBtn.addEventListener('click', toggleSidebar);
            checkMobile();
            window.addEventListener('resize', () => checkMobile());
        });

        window.onload = () => {
            const inputField = document.getElementById("userInput");
            inputField.focus();
        };

        window.onkeydown = () => {
            document.getElementById("userInput").focus();
        };

        function handleKeyPress(event) {
            if (event.key === "Enter") {
                sendPrompt();
            }
        }

        async function sendPrompt() {
            const inputField = document.getElementById("userInput");
            const userMessage = inputField.value.trim();
            inputField.value = "";

            if (!userMessage) return;

            appendMessage(userMessage, 'user');

            // Prepare the AI's message bubble
            aiMessageElement = createMessageElement('', 'agent');
            chatContainer.appendChild(aiMessageElement);
            scrollToBottom();

            const requestBody = {
                model: 'llama3.2:1b',
                prompt: userMessage,
                context: []
            };

            try {
                const response = await fetch('http://127.0.0.1:3001/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error("Bad Request");
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let done = false;
                let tokenBuffer = '';

                while (!done) {
                    const { value, done: readerDone } = await reader.read();
                    done = readerDone;

                    if (value) {
                        tokenBuffer += decoder.decode(value, { stream: true });
                        const tokens = tokenBuffer.split('\n');
                        tokenBuffer = tokens.pop();

                        tokens.forEach(token => {
                            if (token.trim()) {
                                try {
                                    const parsed = JSON.parse(token);
                                    aiMessageElement.textContent += parsed.response; // Append new tokens
                                    scrollToBottom(); // Ensure autoscroll during streaming
                                } catch (error) {
                                    console.error("Error parsing token:", error);
                                }
                            }
                        });
                    }
                }

                aiMessageElement = null;

            } catch (error) {
                aiMessageElement = null;
                appendMessage(`Error: ${error.message}`, 'agent');
            }
        }

        function createMessageElement(message, sender) {
            const messageElement = document.createElement("div");
            messageElement.classList.add('p-2', 'rounded-md', 'mb-2', 'w-fit', 'max-w-full');

            if (sender === 'user') {
                messageElement.classList.add('bg-blue-500', 'self-end', 'text-white');
            } else if (sender === 'agent') {
                messageElement.classList.add('bg-gray-700', 'text-white', 'self-start');
            }

            messageElement.textContent = message;
            return messageElement;
        }

        function appendMessage(message, sender) {
            const messageElement = createMessageElement(message, sender);
            chatContainer.appendChild(messageElement);
            scrollToBottom();
        }

        function scrollToBottom() {
            if (autoScroll) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        function disableAutoscroll() {
            autoScroll = false;
            showAutoscrollButton();
        }

        function enableAutoscroll() {
            autoScroll = true;
            scrollToBottom();
            hideAutoscrollButton();
        }

        function showAutoscrollButton() {
            autoscrollButton.classList.remove('hidden');
        }

        function hideAutoscrollButton() {
            autoscrollButton.classList.add('hidden');
        }

        // Check if the user has scrolled away from the bottom
        chatContainer.addEventListener('scroll', () => {
            const isAtBottom = chatContainer.scrollHeight - chatContainer.scrollTop <= chatContainer.clientHeight + 1; // Tolerance

            if (!isAtBottom && autoScroll) {
                disableAutoscroll();
            } else if (isAtBottom && !autoScroll) {
                enableAutoscroll();
            }
        });
    </script>

</body>
</html>